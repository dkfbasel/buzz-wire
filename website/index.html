<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>WebSocket</title>

	<link rel="stylesheet" href="style.css">
</head>
<body>

	<div id="container">

		<!-- show start/stop button -->
		<div class="buttons">
			<div id="buttonMan" class="button">Mann</div>
			<div id="buttonWoman" class="button">Frau</div>
		</div>

		<div class="elements">

			<!-- was the start of the wire touched -->
			<div>
				<div class="title">Start</div>
				<div class="counter" id="contact-start">--</div>
			</div>

			<!-- how many times was the wire touched -->
			<div>
				<div class="title">Ber√ºhrungen</div>
				<div class="counter" id="contact-wire">0</div>
			</div>

			<!-- how much time elapsed since the start -->
			<div>
				<div class="title">Zeit</div>
				<div class="counter" id="time">00:00</div>
			</div>

			<!-- was the end of the wire touched -->
			<div>
				<div class="title">Finish</div>
				<div class="counter" id="contact-end">--</div>
			</div>

		</div>

		<!-- log all events from websocket -->
		<pre id="console"></pre>

	</div>

	<!-- use special reconnectingWebsockets and lodash -->
	<script type="text/javascript" src="websocket.min.js"></script>
	<script type="text/javascript" src="lodash.min.js"></script>

	<script>

		// create a reconnecting websocket
		var loc = window.location;
		var uri = 'ws:';

		uri += '//' + loc.host;
		uri += loc.pathname + 'ws';

		// open an auto-reconnecting websocket
		var ws = new ReconnectingWebSocket(uri);
		ws.debug = false;

		ws.onopen = function() {
			console.log('Connected to the game engine')
		}

		// get our element for manipulation
		var out = document.getElementById('console');
		var buttonMan = document.getElementById('buttonMan');
		var buttonWoman = document.getElementById('buttonWoman');

		var start = document.getElementById('contact-start');
		var finish = document.getElementById('contact-end');
		var contacts = document.getElementById('contact-wire');

		var time = document.getElementById('time');

		// define some variables to have a ticking timer
		var startTime;
		var timerReference;

		var showTimer = function() {
			var currentTime = new Date().getTime();
			var durationInMillisecs = currentTime - startTime;

			time.innerHTML = (durationInMillisecs / 1000).toFixed(1);
		}

		ws.onmessage = function(event) {
			// get the message of the event
			message = event.data;

			// split the message into separate tokens
			tokens = message.split("::");

			// preserve the message in our console
			out.innerHTML += message + '\n';

			switch (tokens[1]) {
				case "start":

					// indicate the button pressed
					start.innerHTML = tokens[2];
					if (tokens[2] == "female") {
						buttonWoman.className = "button glowing";
					} else {
						buttonMan.className = "button glowing";
					}

					// reset the timer and finish text
					contacts.innerHTML = "0";
					time.innerHTML = "00:00";
					finish.innerHTML = "--";

					// start a ticking clock
					startTime = new Date().getTime();
					window.clearInterval(timerReference);
					timerReference = window.setInterval(showTimer, 10);
					break;

				case "contact":
					// show the number of contacts with the wire
					contacts.innerHTML = tokens[2];
					break;

				case "finished":
					// clear the ticking clock
					window.clearInterval(timerReference);

					// clear the button indicators
					buttonWoman.className = "button";
					buttonMan.className = "button";

					// clear the start info
					start.innerHTML = "--";

					// show the finish info (including time, contacts, ..)
					finish.innerHTML = tokens[2];
					time.innerHTML = tokens[3];
					break;
			}
		}

		ws.onclose = function() {
			console.log('Closed connection to the game engine');
		}

	</script>
</body>
</html>
